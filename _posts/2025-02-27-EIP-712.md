---
layout: post
title: "EIP-712"
date: 2025-02-27 10:00:00 +0800
categories: Web3
---

## ä¸€ã€EIP-712 æ˜¯ä»€ä¹ˆï¼Ÿ

### ğŸ“˜ å®šä¹‰

**EIP-712** å…¨åï¼š**Ethereum Typed Structured Data Hashing and Signing**

å®ƒæ˜¯ä¸€ç§**ç»“æ„åŒ–æ•°æ®ç­¾åæ ‡å‡†**ã€‚

---

### ğŸ§  ç”¨ä¸€å¥è¯è§£é‡Š

**EIP-712** = è®©é’±åŒ…å¯ä»¥å®‰å…¨åœ°ç­¾åã€Œç»“æ„åŒ–æ•°æ®ã€ï¼Œè€Œä¸æ˜¯åªç­¾åä¸€æ®µçœ‹ä¸æ‡‚çš„å­—ç¬¦ä¸²ã€‚

---

## äºŒã€ä¸ºä»€ä¹ˆéœ€è¦ EIP-712ï¼Ÿ

åœ¨ EIP-712 ä¹‹å‰ï¼Œç­¾åæ˜¯è¿™æ ·çš„ï¼š

```
sign("I agree to send 1 ETH to 0xabc...")
```

**é—®é¢˜ï¼š**

- ç”¨æˆ·çœ‹ä¸æ‡‚
- å®¹æ˜“è¢«é’“é±¼
- é’±åŒ…æ— æ³•è§£æå­—æ®µ
- ä¸çŸ¥é“è‡ªå·±ç­¾çš„æ˜¯ä»€ä¹ˆç»“æ„

---

**EIP-712 è§£å†³æ–¹æ¡ˆï¼š** ç­¾åç»“æ„åŒ– JSON æ•°æ®ï¼Œä¾‹å¦‚ï¼š

```json
{
  "domain": {
    "name": "MyDApp",
    "version": "1",
    "chainId": 1
  },
  "message": {
    "from": "0x123...",
    "amount": "1000000000000000000"
  }
}
```

é’±åŒ…ä¼šæ˜¾ç¤ºï¼š

- Send 1 ETH
- From: 0x123...
- To: MyDApp

âœ… ç”¨æˆ·å¯è¯» | âœ… æ›´å®‰å…¨ | âœ… é˜²æ­¢è·¨é“¾é‡æ”¾æ”»å‡»

---

## ä¸‰ã€EIP-712 æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

å®ƒæ˜¯å¾ˆå¤šæ ¸å¿ƒ Web3 åŠŸèƒ½çš„åŸºç¡€ã€‚

---

### 1ï¸âƒ£ ERC-20 Permitï¼ˆERC-2612ï¼‰

**ä½œç”¨ï¼š**

- ä¸ç”¨å‘é“¾ä¸Š approve äº¤æ˜“
- ç›´æ¥ç­¾åæˆæƒ
- èŠ‚çœ gas

æ ¸å¿ƒå°±æ˜¯ EIP-712 ç­¾åã€‚

---

### 2ï¸âƒ£ NFT Permit

å¾ˆå¤š NFT å¸‚åœºä½¿ç”¨ EIP-712ï¼š

- ä½ ç­¾åæŒ‚å•
- åˆ«äººå¸®ä½ æ‰§è¡Œ

---

### 3ï¸âƒ£ Gasless äº¤æ˜“ / Meta-transaction

**ç”¨æˆ·ï¼š**

- åªç­¾å
- ä¸ä»˜ gas

Relayer å¸®ä½ å‘äº¤æ˜“ã€‚åº•å±‚ = EIP-712ã€‚

---

### 4ï¸âƒ£ Account Abstraction (AA)

å¦‚ **ERC-4337**ï¼ŒAA é’±åŒ…çš„ UserOperation å°±æ˜¯ EIP-712 ç»“æ„ç­¾åã€‚ä½ å¦‚æœè¦åšæ™ºèƒ½é’±åŒ…ï¼Œè¿™ä¸ªå¿…é¡»æ‡‚ã€‚

---

## å››ã€EIP-712 çš„æ ¸å¿ƒç»“æ„

å®ƒæœ‰ 3 ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼š

---

### â‘  Domain Separator

é˜²æ­¢è·¨é“¾é‡æ”¾ï¼š

```javascript
{
  name: "MyDApp",
  version: "1",
  chainId: 11155111,
  verifyingContract: "0x..."
}
```

**ä½œç”¨ï¼š** ç»‘å®šé“¾ã€ç»‘å®šåˆçº¦ã€ç»‘å®šåº”ç”¨

---

### â‘¡ Types

å®šä¹‰æ•°æ®ç»“æ„ï¼š

```javascript
types: {
  Mail: [
    { name: "from", type: "address" },
    { name: "amount", type: "uint256" },
  ];
}
```

---

### â‘¢ Message

çœŸæ­£ç­¾åçš„å†…å®¹ï¼š

```javascript
message: {
  from: "0x123...",
  amount: "1000"
}
```

---

## äº”ã€æ€ä¹ˆç”¨ï¼Ÿ

ä»¥ MetaMask ä¸ºä¾‹ã€‚

### å‰ç«¯è°ƒç”¨

ä½¿ç”¨ `eth_signTypedData_v4`ï¼š

```javascript
await window.ethereum.request({
  method: "eth_signTypedData_v4",
  params: [address, JSON.stringify(data)],
});
```

---

### wagmi + viem

å»ºè®®ä½¿ç”¨ï¼š

- `useSignTypedData`
- viem çš„ `signTypedData`

```javascript
const { signTypedData } = useSignTypedData();

signTypedData({
  domain,
  types,
  primaryType: "Mail",
  message,
});
```

---

### Solidity éªŒè¯ç­¾å

ç”¨ OpenZeppelinï¼š

```solidity
import "@openzeppelin/contracts/utils/cryptography/EIP712.sol";

// åˆçº¦é‡Œ
bytes32 digest = _hashTypedDataV4(structHash);
address signer = ECDSA.recover(digest, signature);
```

---

## å…­ã€åº•å±‚åŸç†ï¼ˆæ ¸å¿ƒï¼‰

ç­¾åçš„ä¸æ˜¯ JSONã€‚çœŸå®ç­¾åçš„æ˜¯ï¼š

```
keccak256(
  "\x19\x01" ||
  domainSeparator ||
  structHash
)
```

**è¿™ä¿è¯ï¼š**

- ç­¾åä¸å¯ä¼ªé€ 
- ä¸å¯è·¨é“¾
- ä¸å¯è·¨åˆçº¦
